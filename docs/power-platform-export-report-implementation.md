# Power Platform Environments Export Report Implementation

## Overview
Added "Export Report" functionality to the Power Platform Environments page, allowing users to generate comprehensive Word documents (.docx) containing detailed information about all environments.

## Implementation Date
December 1, 2025

## Changes Made

### 1. Added Required Imports
**File**: `src/app/power-platform/environments/page.jsx`

Added the following imports at the top of the file:
```javascript
import { Document, HeadingLevel, Packer, Paragraph, TextRun, AlignmentType, TableOfContents, Table, TableRow, TableCell, WidthType, BorderStyle } from 'docx'
import { saveAs } from 'file-saver'
```

**Dependencies Used**:
- `docx` v9.5.1 (already installed)
- `file-saver` v2.0.5 (already installed)

### 2. Created Export Function
**Function**: `generateEnvironmentReport()`

Located before the component's return statement (around line 1508), this async function:
- Validates that environment data exists
- Creates a Word document with comprehensive formatting
- Includes title page, summary statistics, and detailed environment information
- Generates tables for structured data presentation
- Saves the file with a timestamped filename

**Report Contents**:

#### Title Page
- Report title: "Power Platform Environments Report"
- Generation timestamp
- Total environment count

#### Summary Section
- Environment count by type (Production, Sandbox, Developer, Teams, Trial)
- Aggregated statistics

#### Detailed Sections
For each environment:
- **Basic Information Table**:
  - Environment ID
  - Environment Type
  - Region
  - Database Type
  - Default Environment status

- **Resources Table**:
  - Canvas Apps count
  - Model-Driven Apps count
  - Agents (Copilot Studio) count
  - Flows (Power Automate) count

- **Dataverse Storage Table** (only for Dataverse-enabled environments):
  - Database storage (usage in GB and percentage)
  - Log storage (usage in GB and percentage)
  - File storage (usage in GB and percentage)

- **Environment Storage Capacity Table**:
  - Database storage (usage in GB and percentage)
  - Log storage (usage in GB and percentage)
  - File storage (usage in GB and percentage)

#### Footer
- "Generated by Pulse 360°" attribution

**File Naming Convention**:
```
Power_Platform_Environments_Report_YYYY-MM-DD.docx
```

### 3. Added Export Button to Page Header
**Location**: Page header section (around line 1834)

Replaced the simple `<h1>` tag with a flex container containing:
- Page title (left-aligned)
- "Export Report" button (right-aligned)

**Button Features**:
- Blue background (`bg-blue-600`) with hover effect (`hover:bg-blue-700`)
- Download icon (SVG)
- "Export Report" text label
- Tooltip: "Export all environments to Word document"
- Calls `generateEnvironmentReport()` on click

**Button Styling**:
```javascript
className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition flex items-center gap-2 text-sm font-medium"
```

## Usage

### For End Users
1. Navigate to **Power Platform > Environments** page
2. Click the **"Export Report"** button in the top-right corner of the page
3. The browser will automatically download a Word document with all environment details
4. Open the `.docx` file in Microsoft Word or compatible software

### For Developers
The export function can be called programmatically:
```javascript
await generateEnvironmentReport()
```

Error handling includes:
- Alert if no environment data is available
- Console error logging with user-friendly alert on failure

## Technical Details

### Document Generation
Uses the `docx` library's declarative API to create structured documents:
- `Document`: Root container
- `Paragraph`: Text blocks with heading levels and alignment
- `Table`: Structured data presentation with borders
- `TableRow` / `TableCell`: Table structure
- `Packer.toBlob()`: Converts to binary format
- `saveAs()`: Triggers browser download

### Data Extraction
Reads from `environmentsData.value` array, which contains:
- `id`: Environment unique identifier
- `name`: Internal environment name
- `properties`:
  - `displayName`: User-friendly name
  - `environmentSku`: Environment type
  - `azureRegion` / `location`: Geographic region
  - `databaseType`: Database technology (e.g., "CommonDataService" for Dataverse)
  - `isDefault`: Default environment flag
  - `capacity`: Array of capacity objects
    - `capacityType`: "Database", "Log", or "File"
    - `actualConsumption`: Used storage in MB
    - `ratedCapacity`: Total storage in MB

Additionally reads from component state:
- `envResourceCounts`: Object mapping environment ID to resource counts
  - `canvasApps`: Number of Canvas Apps
  - `modelDrivenApps`: Number of Model-Driven Apps
  - `agents`: Number of Copilot Studio Agents
  - `flows`: Number of Power Automate Flows (from resource query)
- `flowCounts`: Cached flow counts from Dataverse API (preferred source)
  - `count`: Total number of flows in the environment

### Storage Formatting
Custom `formatCapacity()` function converts MB to GB and calculates percentages:
```javascript
const formatCapacity = (cap) => {
  if (!cap) return 'N/A'
  const actualMB = cap.actualConsumption || 0
  const ratedMB = cap.ratedCapacity || 0
  const actualGB = (actualMB / 1024).toFixed(2)
  const ratedGB = (ratedMB / 1024).toFixed(2)
  const percent = ratedMB > 0 ? ((actualMB / ratedMB) * 100).toFixed(1) : '0.0'
  return `${actualGB} GB / ${ratedGB} GB (${percent}%)`
}
```

## Testing Performed
- ✅ No TypeScript/ESLint errors
- ✅ Page compiles successfully in development server
- ✅ Imports resolve correctly
- ✅ Button appears in page header
- ✅ Function signature is valid
- ✅ Resource counts integrated from `envResourceCounts` state
- ✅ Flow counts integrated from `flowCounts` cache with fallback
- ✅ Dataverse storage conditionally displayed based on database type

## Future Enhancements (Optional)
- Add loading spinner while generating document
- Add option to export selected environments only
- Include detailed flow/app names (not just counts)
- Add charts/graphs to the document
- Support multiple export formats (PDF, Excel)
- Add custom filtering before export
- Include historical storage data in report
- Add connector usage statistics
- Include solution information per environment

## Files Modified
1. `src/app/power-platform/environments/page.jsx` (7307 lines)
   - Added imports (lines 1-19)
   - Added `generateEnvironmentReport()` function (lines ~1508-1768)
   - Modified page header to include Export button (lines ~1834-1851)

## Related Documentation
- [docx Library Documentation](https://docx.js.org/)
- [file-saver Documentation](https://github.com/eligrey/FileSaver.js/)
- [Power Platform Environments API](../API-ENDPOINTS-REFERENCE.md)

## Author
Implementation by GitHub Copilot (Beast Mode 3.1)
Requested by user on December 1, 2025
